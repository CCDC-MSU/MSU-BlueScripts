"""
Vulnerability Injector Module for CCDC framework
Creates system misconfigurations and "bad" state for testing hardening modules.
"""

import logging
from typing import List
from .base import HardeningModule, HardeningCommand, PythonAction, HardeningResult

logger = logging.getLogger(__name__)

class VulnerabilityInjectorModule(HardeningModule):
    """
    Injects vulnerabilities and misconfigurations into the system.
    Used for testing the effectiveness of hardening modules.
    """
    
    def get_name(self) -> str:
        return "vulnerability_injector"
    
    def get_commands(self) -> List[HardeningCommand]:
        commands = []
        
        # 1. user_hardening: Create bad users and sudoers
        commands.append(HardeningCommand(
            command="useradd -m -s /bin/bash hacker && echo 'hacker:password123' | chpasswd",
            description="Create 'hacker' user with weak password",
            check_command="id hacker >/dev/null 2>&1 && echo exists",
            requires_sudo=True
        ))
        
        commands.append(HardeningCommand(
            command="echo 'hacker ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/hacker",
            description="Give 'hacker' NOPASSWD sudo access",
            check_command="test -f /etc/sudoers.d/hacker && echo exists",
            requires_sudo=True
        ))
        
        # 2. ssh_hardening: Revert sshd_config to insecure state
        commands.append(HardeningCommand(
            command="sed -i 's/^PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config || echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config",
            description="Enable Root Login in SSH",
            requires_sudo=True
        ))
        
        commands.append(HardeningCommand(
            command="sed -i 's/^PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config || echo 'PasswordAuthentication yes' >> /etc/ssh/sshd_config",
            description="Enable Password Authentication in SSH",
            requires_sudo=True
        ))
        
        # Remove AllowUsers if present
        commands.append(HardeningCommand(
            command="sed -i '/^AllowUsers/d' /etc/ssh/sshd_config",
            description="Remove AllowUsers restriction",
            requires_sudo=True
        ))
        
        # Reload SSH to apply bad config (reload is safer than restart to avoid lockout if config is invalid, though we made it validly bad)
        commands.append(PythonAction(
            function=self._reload_ssh,
            description="Reload SSH to apply insecure config",
            requires_sudo=True
        ))

        # 3. firewall_hardening: Flush rules
        commands.append(PythonAction(
            function=self._flush_firewall,
            description="Flush all firewall rules (Open Policy)",
            requires_sudo=True
        ))
        
        # 4. package_installer: Uninstall critical tools
        # We'll try to remove 'auditd' if it exists.
        commands.append(HardeningCommand(
            command="apt-get remove -y auditd || yum remove -y audit || apk del audit || true",
            description="Uninstall auditd (if present)",
            requires_sudo=True
        ))
        
        # 5. logging_setup: Break logging config
        commands.append(HardeningCommand(
            command="mv /etc/rsyslog.d/ccdc-security.conf /etc/rsyslog.d/ccdc-security.conf.bak 2>/dev/null || true",
            description="Disable CCDC rsyslog config",
            requires_sudo=True
        ))
         
        # 6. agent_account: Remove scan-agent
        commands.append(HardeningCommand(
            command="userdel -r scan-agent 2>/dev/null || true",
            description="Remove scan-agent account",
            requires_sudo=True
        ))

        return commands

    def _reload_ssh(self, conn, server_info):
        """Reload SSH service"""
        # Simple best effort
        cmd = "systemctl reload sshd || service sshd reload || systemctl reload ssh || service ssh reload"
        conn.sudo(cmd, warn=True, hide=True)
        return HardeningResult(True, "reload_ssh", "Reload SSH", "Reloaded")

    def _flush_firewall(self, conn, server_info):
        """Flush firewalls to allow all"""
        # IPTables
        conn.sudo("iptables -P INPUT ACCEPT; iptables -P OUTPUT ACCEPT; iptables -F", warn=True, hide=True)
        # NFTables
        conn.sudo("nft flush ruleset", warn=True, hide=True)
        # Firewalld - just stop it
        conn.sudo("systemctl stop firewalld", warn=True, hide=True)
        # UFW
        conn.sudo("ufw disable", warn=True, hide=True)
        
        return HardeningResult(True, "flush_firewall", "Flush Firewall", "Firewalls flushed/stopped")
